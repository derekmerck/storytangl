name: CI

on:
  push:
    branches-ignore:
      # codex usually runs its own tests and only pushes a branch for a p/r
      # so this keeps it from running ci redundantly
      - "codex*"
      - "codex/**"
  pull_request:
    branches: ["**"]

jobs:
  python-tests:
    # pyproject includes tests for engine, apps/cli, apps/server, docs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true  # This pulls LFS files automatically
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: "poetry.lock"
      - name: Install dependencies
        env:
          POETRY_VIRTUALENVS_CREATE: "true"
        run: |
          python -m pip install --upgrade pip
          pip install poetry uv
          uv python install 3.13
          poetry env use "$(uv python find 3.13)"
          poetry install --no-interaction --with dev
          pip install . -e
      - name: Run tests
        env:
          PYTHONPATH: "engine/src:apps/cli/src:apps/rest/src"
        run: |
          poetry run pytest -W ignore::DeprecationWarning -W ignore::pytest.PytestCollectionWarning

  web-client-tests:
    # vite tests for apps/web
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: 'apps/web/yarn.lock'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Type check
        run: yarn type-check

      - name: Run tests
        run: yarn test --run

      - name: Build
        run: yarn build

  distribution-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true  # This pulls LFS files automatically

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: "poetry.lock"

      - name: Build wheel
        run: |
          python -m pip install --upgrade pip
          pip install poetry uv
          uv python install 3.13
          poetry env use "$(uv python find 3.13)"
          poetry build

      - name: Install from wheel (not editable)
        run: |
          pip install dist/*.whl

      - name: Test console scripts work
        run: |
          which tangl-cli
          which tangl-serve
#          cli --help
#          serve --help

      # todo: maybe rerun all tests under a full install?
      #       check that lfs files were properly included
      - name: Run distribution tests
        run: |
          pip install pytest
          pytest engine/tests/test_package_distribution.py -v -W ignore::DeprecationWarning -W ignore::pytest.PytestCollectionWarning